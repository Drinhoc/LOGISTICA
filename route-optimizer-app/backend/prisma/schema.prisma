// Prisma schema for route optimizer backend using PostgreSQL
// Models cover users, businesses, drivers, costs, routes, assignments, and stops

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  OWNER
  ADMIN
  DISPATCHER
  DRIVER
}

enum RouteStatus {
  DRAFT
  OPTIMIZED
  DISPATCHED
  COMPLETED
  CANCELLED
}

model User {
  id           String    @id @default(uuid())
  name         String
  email        String    @unique
  passwordHash String
  role         UserRole  @default(USER)
  businessId   String?
  business     Business? @relation(fields: [businessId], references: [id])
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model Business {
  id           String        @id @default(uuid())
  name         String
  description  String?
  baseAddress  String?
  baseLatitude Decimal?      @db.Decimal(10, 7)
  baseLongitude Decimal?     @db.Decimal(10, 7)
  contactEmail String?
  contactPhone String?
  users        User[]
  drivers      Driver[]
  costSettings CostSettings?
  routes       Route[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model Driver {
  id           String         @id @default(uuid())
  name         String
  phone        String?
  vehicleType  String?
  isActive     Boolean        @default(true)
  businessId   String
  business     Business       @relation(fields: [businessId], references: [id])
  assignments  DriverRoute[]
  assignedStops Stop[]        @relation("StopDriver")
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
}

model CostSettings {
  id          String    @id @default(uuid())
  businessId  String    @unique
  business    Business  @relation(fields: [businessId], references: [id])
  costPerKm   Decimal   @db.Decimal(10, 2)
  costPerHour Decimal   @db.Decimal(10, 2)
  currency    String    @default("BRL")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Route {
  id                 String        @id @default(uuid())
  businessId         String
  business           Business      @relation(fields: [businessId], references: [id])
  name               String
  scheduledDate      DateTime?
  status             RouteStatus   @default(DRAFT)
  totalDistanceKm    Decimal?      @db.Decimal(10, 2)
  totalDurationMinutes Int?
  totalCost          Decimal?      @db.Decimal(12, 2)
  googleMapsLink     String?
  whatsappMessage    String?
  assignments        DriverRoute[]
  stops              Stop[]
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
}

model DriverRoute {
  id             String   @id @default(uuid())
  routeId        String
  driverId       String
  route          Route    @relation(fields: [routeId], references: [id])
  driver         Driver   @relation(fields: [driverId], references: [id])
  position       Int
  distanceKm     Decimal? @db.Decimal(10, 2)
  durationMinutes Int?
  cost           Decimal? @db.Decimal(12, 2)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([routeId, driverId])
  @@index([driverId])
  @@index([routeId])
}

model Stop {
  id                     String    @id @default(uuid())
  routeId                String
  route                  Route     @relation(fields: [routeId], references: [id])
  order                  Int
  title                  String
  address                String
  latitude               Decimal?  @db.Decimal(10, 7)
  longitude              Decimal?  @db.Decimal(10, 7)
  etaMinutes             Int?
  serviceMinutes         Int?
  distanceFromPreviousKm Decimal?  @db.Decimal(10, 2)
  notes                  String?
  assignedDriverId       String?
  assignedDriver         Driver?   @relation("StopDriver", fields: [assignedDriverId], references: [id])
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  @@index([routeId])
}
